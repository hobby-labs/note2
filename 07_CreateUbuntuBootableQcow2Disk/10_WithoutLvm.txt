```
mkdir -p $HOME/cloud-image-ubuntu-from-scratch
cd $HOME/cloud-image-ubuntu-from-scratch
dd if=/dev/zero of=cloud-ubuntu-image.raw bs=1 count=0 seek=32212254720 status=progress
```

```
sgdisk -z cloud-ubuntu-image.raw
timeout 10 dd if=/dev/zero of=cloud-ubuntu-image.raw bs=4M
sgdisk -n 1:0:+512M -t 1:ef00 -c 1:"EFI System" cloud-ubuntu-image.raw
sgdisk -n 2:0:+512M -t 2:8300 -c 2:"Linux filesystem" cloud-ubuntu-image.raw
sgdisk -n 3:0: -t 3:8300 -c 3:"Linux filesystem" cloud-ubuntu-image.raw
```

```
sudo losetup -fP cloud-ubuntu-image.raw
sudo losetup -a | grep cloud-ubuntu-image.raw
> /dev/loop3: [64769]:201335002 (/root/cloud-image-ubuntu-from-scratch/cloud-ubuntu-image.raw)
```

In this example, the loop device was created as /dev/loop3.
Set the variable L_DEV=/dev/loop3.

```
L_DEV=/dev/loop3
```

```
sudo gdisk -l ${L_DEV}
> ...
> Number  Start (sector)    End (sector)  Size       Code  Name
>    1            2048         1050623   512.0 MiB   EF00  EFI System
>    2         1050624         2099199   512.0 MiB   8300  Linux filesystem
>    3         2099200        54237190   24.9 GiB    8E00  Linux LVM

ls -l ${L_DEV}*
> brw-rw---- 1 root disk   7, 4 Mar 18 14:46 /dev/loop3
> brw-rw---- 1 root disk 259, 0 Mar 18 14:46 /dev/loop3p1
> brw-rw---- 1 root disk 259, 1 Mar 18 14:46 /dev/loop3p2
> brw-rw---- 1 root disk 259, 2 Mar 18 14:46 /dev/loop3p3
```

```
mkfs.vfat -F32 ${L_DEV}p1
mkfs.ext4 ${L_DEV}p2
mkfs.xfs ${L_DEV}p3

cd $HOME/cloud-image-ubuntu-from-scratch
mkdir -p chroot
sudo mount ${L_DEV}p3 chroot
sudo mkdir -p chroot/boot
sudo mount ${L_DEV}p2 chroot/boot
sudo mkdir -p chroot/boot/efi
sudo mount ${L_DEV}p1 chroot/boot/efi
```

```
sudo debootstrap \
   --arch=amd64 \
   --variant=minbase \
   --components "main,universe" \
   --include "ca-certificates,cron,iptables,isc-dhcp-client,libnss-myhostname,ntp,ntpdate,rsyslog,ssh,sudo,dialog,whiptail,man-db,curl,dosfstools,e2fsck-static" \
   jammy \
   $HOME/cloud-image-ubuntu-from-scratch/chroot \
   http://jp.archive.ubuntu.com/ubuntu/
```

```
sudo mount --rbind /dev $HOME/cloud-image-ubuntu-from-scratch/chroot/dev
sudo mount --rbind /run $HOME/cloud-image-ubuntu-from-scratch/chroot/run
sudo mount --rbind /sys $HOME/cloud-image-ubuntu-from-scratch/chroot/sys
sudo mount --rbind /proc $HOME/cloud-image-ubuntu-from-scratch/chroot/proc
```

```
sudo chroot $HOME/cloud-image-ubuntu-from-scratch/chroot /usr/bin/env L_DEV=${L_DEV} /bin/bash --login
```

```
export HOME=/root
export LC_ALL=C
echo "anonymous" > /etc/hostname
```

```
cat << EOF > /etc/apt/sources.list
deb http://jp.archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
deb-src http://jp.archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse

deb http://jp.archive.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
deb-src http://jp.archive.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse

deb http://jp.archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
deb-src http://jp.archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
EOF
```

```
blkid ${L_DEV}*
/dev/loop4: PTUUID="2c94d9c1-d1ad-47ed-86e5-702b3b22558e" PTTYPE="gpt"
/dev/loop4p1: UUID="4897-AAED" BLOCK_SIZE="512" TYPE="vfat" PARTLABEL="EFI System" PARTUUID="8184f2b8-e2fd-48c5-861b-5a478276246e"
/dev/loop4p2: UUID="6eb46b60-ad2c-4c1d-9d88-471d92f2df3e" BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="Linux filesystem" PARTUUID="2bfd4fb0-7a9f-48a2-a625-b0a6017d0f76"
/dev/loop4p3: UUID="9d993822-469e-4220-87dc-69f69c982d2c" BLOCK_SIZE="512" TYPE="xfs" PARTLABEL="Linux filesystem" PARTUUID="83015dc0-efb2-4134-b298-a84f5d36f28c"
```

```
cat << EOF > /etc/fstab
UUID="9d993822-469e-4220-87dc-69f69c982d2c" / xfs rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota        0 1
UUID="6eb46b60-ad2c-4c1d-9d88-471d92f2df3e" /boot ext4 rw,relatime     0 2
UUID="4897-AAED"       /boot/efi       vfat    rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro   0 2
EOF
```

```
apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y systemd-sysv
```

```
dbus-uuidgen > /etc/machine-id
ln -fs /etc/machine-id /var/lib/dbus/machine-id
```

```
dpkg-divert --local --rename --add /sbin/initctl
ln -s /bin/true /sbin/initctl
```

```
DEBIAN_FRONTEND=noninteractive apt-get install -y \
    xfsprogs os-prober ifupdown \
    network-manager resolvconf locales \
    build-essential module-assistant cloud-init \
    grub2 grub-pc linux-generic
```

```
cat <<EOF > /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback
EOF
```

Set locale.

```
# https://serverfault.com/a/689947
echo "Asia/Tokyo" > /etc/timezone
dpkg-reconfigure -f noninteractive tzdata

sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
sed -i -e 's/# ja_JP.UTF-8 UTF-8/ja_JP.UTF-8 UTF-8/' /etc/locale.gen
dpkg-reconfigure --frontend=noninteractive locales
update-locale LANG=en_US.UTF-8
```

```
dpkg-reconfigure resolvconf -f noninteractive
```

```
cat <<EOF > /etc/NetworkManager/NetworkManager.conf
[main]
rc-manager=resolvconf
plugins=ifupdown,keyfile
dns=default

[ifupdown]
managed=false
EOF
```

```
dpkg-reconfigure network-manager -f noninteractive
```

```
# See: https://forums.gentoo.org/viewtopic-t-1118994-start-0.html
apt-get install -y grub-efi zynaddsubfx
#####in make.conf
export GRUB_PLATFORMS="efi-64"
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=ubuntu --boot-directory=/boot/efi/EFI --recheck
#update-grub
grub-mkconfig -o /boot/efi/EFI/ubuntu/grub.cfg
update-initramfs -u
```

```
useradd ubuntu
usermod -aG sudo ubuntu
passwd ubuntu
```

Finished to prepare resources for the cloud image.
Following this instruction, we will create the cloud image(qcow2) from the raw image.

```
truncate -s 0 /etc/machine-id
rm /sbin/initctl
dpkg-divert --rename --remove /sbin/initctl

apt-get clean
rm -rf /tmp/* ~/.bash_history
export HISTSIZE=0
exit
```

Chroot environment was finished.

```
sudo mount --make-rslave $HOME/cloud-image-ubuntu-from-scratch/chroot/
sudo umount -R $HOME/cloud-image-ubuntu-from-scratch/chroot/

sudo losetup -D
```

Convert raw to qcow2.

```
qemu-img convert -f raw cloud-ubuntu-image.raw -O qcow2 ubuntu-image.qcow2
```

---------------------------------------------------

```
grub> ls
> (proc) (memdisk) (hd0) (hd0,gpt3) (ht0,gpt2) (hd0,gpt1) (lvm/lvm--vg01-lvm--vg01--root) (lvm/lvm--vg01-lvm--vg01--log)

grub> ls -l (hd0,gpt2)/
> ...
> vmlinuz-5.15-0-101-generic
> initrd.img-5.15.0-101-generic
> ...

grub> insmod lvm
grub> ##set root=(lvm/lvm--vg01-lvm--vg01--root)
grub> ##linux (hd0,gpt2)/vmlinuz-5.15.0-101-generic root=/dev/mapper/lvm--vg01-lvm--vg01--root
grub> linux (hd0,gpt2)/vmlinuz-5.15.0-101-generic root=UUID=05d7611d-e724-44d1-8ea7-bc64babadbcb
grub> initrd (hd0,gpt2)/initrd.img-5.15.0-101-generic
grub> boot
```

